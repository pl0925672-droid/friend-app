<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friend App - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            overflow-y: auto;
            position: fixed;
            height: 100vh;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .user-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
            font-size: 14px;
        }

        .user-info .name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .user-info .email {
            font-size: 12px;
            opacity: 0.8;
        }

        .nav-item {
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.2);
        }

        .nav-item.active {
            background: rgba(255,255,255,0.3);
            font-weight: 600;
        }

        .logout-btn {
            width: 100%;
            padding: 10px;
            margin-top: 20px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .main {
            margin-left: 250px;
            flex: 1;
            padding: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #999;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .activity-form, .goal-form {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
            font-size: 13px;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            font-size: 13px;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102,126,234,0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        }

        .list-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .list-item-title {
            font-weight: 600;
            color: #333;
        }

        .list-item-meta {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            position: relative;
            width: 100%;
            height: 400px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }

        .notification.success {
            border-left: 4px solid #4caf50;
        }

        .notification.error {
            border-left: 4px solid #f44336;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
                padding: 20px;
            }
            .main {
                margin-left: 200px;
                padding: 15px;
            }
            .header h1 {
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                position: fixed;
                left: -200px;
                transition: all 0.3s ease;
                z-index: 1000;
            }
            .main {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">üìö Friend</div>
            
            <div class="user-info">
                <div class="name" id="userName">User</div>
                <div class="email" id="userEmail">email@example.com</div>
            </div>

            <nav>
                <div class="nav-item active" onclick="switchTab('dashboard')">üìä Dashboard</div>
                <div class="nav-item" onclick="switchTab('activities')">üìç Activities</div>
                <div class="nav-item" onclick="switchTab('goals')">üéØ Goals</div>
                <div class="nav-item" onclick="switchTab('reports')">üìà Reports</div>
            </nav>

            <button class="logout-btn" onclick="logout()">üö™ Logout</button>
        </div>

        <!-- Main Content -->
        <div class="main">
            <div class="header">
                <h1 id="pageTitle">Dashboard</h1>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>This Week</h3>
                        <div class="value" id="weeklyHours">0h</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Activities</h3>
                        <div class="value" id="totalActivities">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Goals</h3>
                        <div class="value" id="activeGoals">0</div>
                    </div>
                </div>
            </div>

            <!-- Activities Section -->
            <div id="activities" class="section">
                <div class="activity-form">
                    <h3 style="margin-bottom: 15px;">üìù Log New Activity</h3>
                    <form onsubmit="addActivity(event)">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div class="form-group">
                                <label>Type</label>
                                <select id="activityType" required>
                                    <option value="study">üìö Study</option>
                                    <option value="exercise">üèÉ Exercise</option>
                                    <option value="reading">üìñ Reading</option>
                                    <option value="break">‚òï Break</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Title</label>
                                <input type="text" id="activityTitle" placeholder="e.g., Math Chapter 5" required>
                            </div>
                            <div class="form-group">
                                <label>Duration (hours)</label>
                                <input type="number" id="activityDuration" placeholder="2" step="0.5" min="0" required>
                            </div>
                            <div class="form-group">
                                <label>Mood</label>
                                <select id="activityMood">
                                    <option value="üòä">üòä Happy</option>
                                    <option value="üòê">üòê Neutral</option>
                                    <option value="üòî">üòî Tired</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit">‚úÖ Save Activity</button>
                    </form>
                </div>

                <h3 style="margin-bottom: 15px;">üìã Your Activities</h3>
                <div id="activitiesList" class="loading">Loading...</div>
            </div>

            <!-- Goals Section -->
            <div id="goals" class="section">
                <div class="goal-form">
                    <h3 style="margin-bottom: 15px;">üéØ Create New Goal</h3>
                    <form onsubmit="addGoal(event)">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div class="form-group" style="grid-column: 1/-1;">
                                <label>Goal Title</label>
                                <input type="text" id="goalTitle" placeholder="e.g., Complete Python Course" required>
                            </div>
                            <div class="form-group">
                                <label>Category</label>
                                <select id="goalCategory">
                                    <option value="study">üìö Study</option>
                                    <option value="fitness">üèÉ Fitness</option>
                                    <option value="career">üíº Career</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Target Hours</label>
                                <input type="number" id="goalTarget" placeholder="50" step="5" min="0" required>
                            </div>
                            <div class="form-group" style="grid-column: 1/-1;">
                                <label>Deadline</label>
                                <input type="date" id="goalDeadline" required>
                            </div>
                        </div>
                        <button type="submit">‚ú® Create Goal</button>
                    </form>
                </div>

                <h3 style="margin-bottom: 15px;">üéØ Your Goals</h3>
                <div id="goalsList" class="loading">Loading...</div>
            </div>

            <!-- Reports Section -->
            <div id="reports" class="section">
                <div class="chart-container">
                    <canvas id="reportsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let authToken = null;
        let currentUser = null;
        let activitiesData = [];
        let goalsData = [];

        // Initialize on page load
        window.addEventListener('load', () => {
            authToken = localStorage.getItem('token');
            if (!authToken) {
                window.location.href = '/login.html';
                return;
            }
            loadCurrentUser();
            loadActivities();
            loadGoals();
        });

        // Load current user info
        async function loadCurrentUser() {
            try {
                const response = await fetch(`${API_BASE}/api/auth/me`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('userName').textContent = currentUser.fullName || currentUser.username;
                    document.getElementById('userEmail').textContent = currentUser.email;
                } else {
                    throw new Error('Failed to load user');
                }
            } catch (error) {
                console.error('Error:', error);
                logout();
            }
        }

        // Load activities
        async function loadActivities() {
            try {
                const response = await fetch(`${API_BASE}/api/activities`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                activitiesData = await response.json() || [];
                renderActivities();
                updateDashboard();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Add activity
        async function addActivity(event) {
            event.preventDefault();
            const activity = {
                type: document.getElementById('activityType').value,
                title: document.getElementById('activityTitle').value,
                duration: parseFloat(document.getElementById('activityDuration').value),
                mood: document.getElementById('activityMood').value,
                date: new Date().toISOString().split('T')[0]
            };

            try {
                const response = await fetch(`${API_BASE}/api/activities`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(activity)
                });

                if (response.ok) {
                    showNotification('‚úÖ Activity saved!', 'success');
                    event.target.reset();
                    loadActivities();
                } else {
                    throw new Error('Failed to save activity');
                }
            } catch (error) {
                showNotification('‚ùå Error: ' + error.message, 'error');
            }
        }

        // Render activities list
        function renderActivities() {
            const container = document.getElementById('activitiesList');
            if (activitiesData.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No activities yet</p>';
                return;
            }
            container.innerHTML = activitiesData
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(activity => `
                    <div class="list-item">
                        <div>
                            <div class="list-item-title">${activity.title}</div>
                            <div class="list-item-meta">
                                ${activity.type} ‚Ä¢ ${activity.duration}h ‚Ä¢ ${activity.mood}
                            </div>
                        </div>
                    </div>
                `).join('');
        }

        // Load goals
        async function loadGoals() {
            try {
                const response = await fetch(`${API_BASE}/api/goals`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                goalsData = await response.json() || [];
                renderGoals();
                updateDashboard();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Add goal
        async function addGoal(event) {
            event.preventDefault();
            const goal = {
                title: document.getElementById('goalTitle').value,
                category: document.getElementById('goalCategory').value,
                target: parseInt(document.getElementById('goalTarget').value),
                deadline: document.getElementById('goalDeadline').value
            };

            try {
                const response = await fetch(`${API_BASE}/api/goals`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(goal)
                });

                if (response.ok) {
                    showNotification('‚ú® Goal created!', 'success');
                    event.target.reset();
                    loadGoals();
                } else {
                    throw new Error('Failed to create goal');
                }
            } catch (error) {
                showNotification('‚ùå Error: ' + error.message, 'error');
            }
        }

        // Render goals list
        function renderGoals() {
            const container = document.getElementById('goalsList');
            if (goalsData.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No goals yet</p>';
                return;
            }
            container.innerHTML = goalsData.map(goal => `
                <div class="list-item">
                    <div style="flex: 1;">
                        <div class="list-item-title">${goal.title}</div>
                        <div class="list-item-meta">
                            Target: ${goal.target}h ‚Ä¢ Deadline: ${goal.deadline}
                        </div>
                        <div style="margin-top: 10px; background: #eee; height: 8px; border-radius: 4px;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${Math.min((goal.current/goal.target)*100, 100)}%; border-radius: 4px;"></div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Update dashboard stats
        function updateDashboard() {
            const weekHours = activitiesData.reduce((sum, act) => sum + act.duration, 0);
            document.getElementById('weeklyHours').textContent = weekHours + 'h';
            document.getElementById('totalActivities').textContent = activitiesData.length;
            document.getElementById('activeGoals').textContent = goalsData.length;

            // Create chart
            if (activitiesData.length > 0) {
                createChart();
            }
        }

        // Create reports chart
        function createChart() {
            const canvas = document.getElementById('reportsChart');
            if (!canvas) return;

            const types = [...new Set(activitiesData.map(a => a.type))];
            const hours = types.map(type => 
                activitiesData
                    .filter(a => a.type === type)
                    .reduce((sum, a) => sum + a.duration, 0)
            );

            if (window.reportsChart) window.reportsChart.destroy();

            window.reportsChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: types.map(t => t.charAt(0).toUpperCase() + t.slice(1)),
                    datasets: [{
                        label: 'Hours',
                        data: hours,
                        backgroundColor: '#667eea',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Switch sections
        function switchTab(tab) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.target.classList.add('active');

            const titles = {
                dashboard: 'üìä Dashboard',
                activities: 'üìç Activities',
                goals: 'üéØ Goals',
                reports: 'üìà Reports'
            };
            document.getElementById('pageTitle').textContent = titles[tab];
        }

        // Show notification
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // Logout
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>
